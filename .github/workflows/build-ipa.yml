name: Build VisionClaw IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Create Secrets.swift
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
        run: |
          GEMINI=$(printf '%s' "$GEMINI_API_KEY" | tr -d '\n\r')
          GATEWAY=$(printf '%s' "$OPENCLAW_GATEWAY_TOKEN" | tr -d '\n\r')
          cat > samples/CameraAccess/CameraAccess/Secrets.swift << SWEOF
          import Foundation
          enum Secrets {
            static let geminiAPIKey = "${GEMINI}"
            static let openClawHost = "https://srv1404265-1.tail1c786c.ts.net"
            static let openClawPort = 18789
            static let openClawHookToken = ""
            static let openClawGatewayToken = "${GATEWAY}"
            static let webrtcSignalingURL = ""
          }
          SWEOF
          echo "Secrets.swift created OK"

      - name: Build (ad-hoc signed)
        run: |
          set -o pipefail
          cd samples/CameraAccess
          xcodebuild \
            -project CameraAccess.xcodeproj \
            -scheme CameraAccess \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./DerivedData \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            build 2>&1

      - name: Package as IPA
        run: |
          cd samples/CameraAccess
          APP_PATH=$(find DerivedData/Build/Products -name "*.app" | grep -v dSYM | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found"
            find DerivedData -name "*.app" || true
            exit 1
          fi
          echo "Found: $APP_PATH"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r VisionClaw.ipa Payload/
          ls -lh VisionClaw.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: VisionClaw-unsigned
          path: samples/CameraAccess/VisionClaw.ipa
          retention-days: 7
